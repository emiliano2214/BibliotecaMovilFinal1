@page "/editoriales"
@using BibliotecaMovil.Shared.DTOs
@using BibliotecaMovil.Shared.Interfaces
@inject IEditorialService EditorialService
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
<div style="background:#777FF5; min-height:100vh; display:flex; flex-direction:column;">
    <div style="padding:40px 20px 10px 20px; display:grid; grid-template-columns:1fr auto; align-items:center;">
        <div style="font-size:26px; font-weight:bold;">Editorial</div>

        <NavLink href="/menu" style="text-decoration:none; color:black; display:block;">
            <div style="background:#0050FF; padding:8px 6px; display:flex; flex-direction:column; gap:3px; cursor:pointer;">
                <div style="height:2px; width:20px; background:black;"></div>
                <div style="height:2px; width:20px; background:black;"></div>
                <div style="height:2px; width:20px; background:black;"></div>
            </div>
        </NavLink>
    </div>

    <div style="flex:1; background:white; overflow:auto;">
        <div style="padding:0 20px 20px 20px;">
            <div style="display:grid; grid-template-columns:1fr 1fr 1fr; font-weight:bold; padding:10px 0;">
                <div>Nombre</div>
                <div>País</div>
                <div>Ciudad</div>

            </div>

            @if (cargando)
            {
                <div style="padding:10px 0;">Cargando...</div>
            }
            else if (!string.IsNullOrWhiteSpace(error))
            {
                <!-- Panel técnico de error -->
                <div style="margin-top:15px; padding:15px; background:#2b0000; color:#ffb3b3; border-radius:6px;">
                    <div style="font-weight:bold; font-size:16px; margin-bottom:8px;">
                        ❌ Error al cargar editoriales
                    </div>

                    <div style="white-space:pre-wrap; font-family:monospace; font-size:13px;">
                        @error
                    </div>

                    <button @onclick="CargarDatos"
                            style="margin-top:10px; padding:6px 12px; background:#ff4d4d; border:none; color:white; cursor:pointer;">
                        Reintentar
                    </button>
                </div>
            }
            else if (editoriales.Count == 0)
            {
                <div style="padding:10px 0;">No hay editoriales registradas.</div>
            }
            else
            {
                @foreach (var e in editoriales)
                {
                    <div style="display:grid; grid-template-columns:1fr 1fr 1fr; padding:6px 0; border-bottom:1px solid #EEE;">
                        <div>@e.Nombre</div>
                        <div>@(string.IsNullOrWhiteSpace(e.Pais) ? "-" : e.Pais)</div>
                        <div>@(string.IsNullOrWhiteSpace(e.Ciudad) ? "-" : e.Ciudad)</div>
                    </div>
                }
            }
        </div>

        <div style="background:#777FF5; padding:10px 20px; color:black; font-weight:bold;">
            Formulario &lt;Accion&gt;
        </div>

        <div style="padding:16px 20px 30px 20px;">
            <div>Nombre</div>
            <input style="width:100%; height:34px; background:#DDDDDD; border:none; margin-bottom:12px;" />
            <div>País</div>
            <input style="width:100%; height:34px; background:#DDDDDD; border:none;" />
            <div>Ciudad</div>
            <input style="width:100%; height:34px; background:#DDDDDD; border:none;" />
        </div>
    </div>
</div>

@code {
    private List<EditorialDto> editoriales = new();
    private bool cargando = true;
    private string? error;

    protected override async Task OnInitializedAsync()
    {
        await CargarDatos();
    }

    private async Task CargarDatos()
    {
        try
        {
            cargando = true;
            error = null;

            editoriales = await EditorialService.GetEditorialesAsync();
        }
        catch (Exception ex)
        {
            // 🔥 Mostramos mensaje + stacktrace
            error = $"{ex.Message}\n\nStackTrace:\n{ex.StackTrace}";
        }
        finally
        {
            cargando = false;
        }
    }
}
