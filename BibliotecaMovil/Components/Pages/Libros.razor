@page "/libros"
@using BibliotecaMovil.Shared.DTOs
@using BibliotecaMovil.Shared.Interfaces
@using Microsoft.AspNetCore.Authorization
@inject ILibroService LibroService
@inject IFavoritoService FavoritoService
@attribute [Authorize(Roles = "Lector, Admin")]
@inject BibliotecaMovil.Services.UsuarioSesionService Sesion


<div style="background:#777FF5; min-height:100vh; display:flex; flex-direction:column;">
    <!-- Header -->
    <!-- Header -->
    <div style="padding:60px 20px 20px 20px; display:flex; flex-direction:column; gap:30px;">

        <!-- Título -->
        <div style="font-size:28px; font-weight:bold;">
            Libros
        </div>

        <!-- Línea inferior (cuadrado izquierda + hamburguesa derecha) -->
        <div style="display:flex; justify-content:space-between; align-items:center;">

            <!-- Cuadrado izquierdo -->
            <div style="width:40px; height:40px; background:#0050FF;"></div>

            <!-- Botón hamburguesa derecho -->
            <NavLink href="/menu" style="text-decoration:none;">
                <div style="
                width:40px; height:40px;
                background:#0050FF;
                display:flex;
                flex-direction:column;
                align-items:center;
                justify-content:center;
                gap:4px;
                cursor:pointer;
            ">
                    <div style="height:2px; width:18px; background:black;"></div>
                    <div style="height:2px; width:18px; background:black;"></div>
                    <div style="height:2px; width:18px; background:black;"></div>
                </div>
            </NavLink>

        </div>

    </div>

    <!-- Lista -->
    <div style="flex:1; background:white;">
        <div style="padding:10px 20px; font-weight:bold;">Lista de Libros</div>
        @if (!string.IsNullOrWhiteSpace(mensaje))
        {
            <div style="padding:10px 20px; color:green; font-weight:bold;">@mensaje</div>
        }
        @if (!string.IsNullOrWhiteSpace(error))
        {
            <div style="padding:10px 20px; color:#b00020; font-weight:bold;">Error: @error</div>
        }

        @if (cargando)
        {
            <div style="padding:20px;">Cargando...</div>
        }
        else if (error is not null)
        {
            <div style="padding:20px; color:#b00020; font-weight:bold;">Error: @error</div>
        }
        else if (!libros.Any())
        {
            <div style="padding:20px;">No hay libros disponibles.</div>
        }
        else
        {
            @foreach (var libro in libros)
            {
                <div style="display:grid; grid-template-columns:1fr auto; align-items:center; margin:10px 0; padding:10px 20px; border-bottom:2px solid #777FF5;">
                    <div>@libro.Titulo</div>

                    <div style="font-size:24px; cursor:pointer;" @onclick="() => ToggleFavorito(libro)">
                        <span style="color:@(EsFavorito(libro) ? "gold" : "gray");">
                            @(EsFavorito(libro) ? "★" : "☆")
                        </span>
                    </div>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<LibroDto> libros = new();
    private HashSet<int> favLibroIds = new();

    private bool cargando = true;
    private string? error;

    private int usuarioId;
    private UsuarioPublicoDto? usuario;

    protected override async Task OnInitializedAsync()
    {
        usuario = await Sesion.ObtenerUsuarioAsync();
        if (usuario is null)
        {
            error = "No hay sesión iniciada.";
            cargando = false;
            return;
        }

        usuarioId = usuario.IdUsuario;
        cargando = true;
        error = null;

        // 1) Libros
        try
        {
            libros = await LibroService.GetLibrosAsync() ?? new();
        }
        catch (Exception ex)
        {
            error = "GET Libros falló: " + ex.Message;
            cargando = false;
            return;
        }

        // 2) Favoritos
        try
        {
            var favoritos = await FavoritoService.GetFavoritosByUsuarioAsync(usuarioId) ?? new();
            favLibroIds = favoritos.Select(f => f.IdLibro).ToHashSet();
        }
        catch (Exception ex)
        {
            error = "GET Favoritos falló: " + ex.Message;
            cargando = false;
            return;
        }

        cargando = false;
    }


    private bool EsFavorito(LibroDto libro) => favLibroIds.Contains(libro.IdLibro);
    private string? mensaje;

    private async Task ToggleFavorito(LibroDto libro)
    {
        try
        {
            error = null;
            mensaje = null;

            var libroId = libro.IdLibro;

            if (favLibroIds.Contains(libroId))
            {
                var ok = await FavoritoService.RemoveFavoritoAsync(usuarioId, libroId);
                if (ok)
                {
                    favLibroIds.Remove(libroId);
                    mensaje = "❌ Favorito eliminado";
                }
                else
                {
                    error = "No se pudo eliminar (no existía o falló).";
                }
            }
            else
            {
                var ok = await FavoritoService.AddFavoritoAsync(new FavoritoDto
                {
                    IdUsuario = usuarioId,
                    IdLibro = libroId,
                    FechaAgregado = DateTime.Now
                });

                if (ok)
                {
                    favLibroIds.Add(libroId);
                    mensaje = "✅ Favorito agregado";
                }
                else
                {
                    error = "No se pudo agregar (ya existía o falló).";
                }
            }
        }
        catch (Exception ex)
        {
            error = ex.Message;
        }
    }

}
