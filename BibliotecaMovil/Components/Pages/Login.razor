@page "/"
@using System.Net.Http.Json
@using BibliotecaMovil.Shared.DTOs
@using BibliotecaMovil.Services
@inject HttpClient Http
@inject NavigationManager Nav
@inject UsuarioSesionService Sesion



<div style="background-color:#777FF5; min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:60px 20px 40px 20px;">
    <div style="margin-bottom:40px; text-align:center;">
        <img src="images/logo_biblioteca.png" alt="Logo" style="max-width:220px; height:auto;" />
    </div>

    <div style="width:100%; max-width:320px;">
        <div style="margin-bottom:14px; color:black;">Usuario</div>
        <input @bind="email" style="width:100%; height:40px; background:#DDDDDD; border:none; margin-bottom:16px;" />

        <div style="margin-bottom:14px; color:black;">Contraseña</div>
        <input type="password" @bind="password" style="width:100%; height:40px; background:#DDDDDD; border:none; margin-bottom:24px;" />

        <button @onclick="LoginAsync" disabled="@isLoading"
                style="width:100%; height:48px; background:#0050FF; color:white; font-weight:bold; border:none; margin-top:10px;">
            @(isLoading ? "Ingresando..." : "Iniciar sesión")
        </button>

        <div style="margin-top:20px; text-align:center; color:white;">
            @mensaje
        </div>

        <div style="margin-top:40px; text-align:center; color:white;">
            si no tenes cuenta registrate
        </div>
    </div>
</div>

@code {
    private string email = "";
    private string password = "";
    private string mensaje = "";
    private bool isLoading = false;

    private async Task LoginAsync()
    {
        isLoading = true;
        mensaje = "Intentando login...";
        try
        {
            var resp = await Http.PostAsJsonAsync("api/Usuario/login", new LoginRequestDto
            {
                Email = email,
                Password = password
            });

            if (!resp.IsSuccessStatusCode)
            {
                var body = await resp.Content.ReadAsStringAsync();
                mensaje = $"Login falló: {resp.StatusCode}";
                Console.WriteLine(body);
                return;
            }

            var login = await resp.Content.ReadFromJsonAsync<LoginResponseDto>();
            if (login is null)
            {
                mensaje = "Login OK pero respuesta inválida";
                return;
            }

            // ✅ Guardar sesión (token + user)
            await Sesion.GuardarSesionAsync(login);

            mensaje = "Login OK ✅";
            Nav.NavigateTo("/home");
        }
        catch (Exception ex)
        {
            mensaje = "Error conectando con la API";
            Console.WriteLine(ex);
        }
        finally
        {
            isLoading = false;
        }
    }
}
