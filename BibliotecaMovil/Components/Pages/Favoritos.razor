@page "/favoritos"
@using BibliotecaMovil.Shared.DTOs
@using BibliotecaMovil.Shared.Interfaces
@using Microsoft.AspNetCore.Authorization
@inject IFavoritoService FavoritoService
@attribute [Authorize(Roles = "Lector, Admin")]
@inject BibliotecaMovil.Services.UsuarioSesionService Sesion

<div style="background:#777FF5; min-height:100vh; display:flex; flex-direction:column;">
    <div style="padding:40px 20px 10px 20px; display:grid; grid-template-columns:1fr auto; column-gap:10px;">
        <div>
            <div style="margin-bottom:6px;">Favoritos</div>
            <input style="width:100%; height:36px; background:#DDDDDD; border:none;"
                   placeholder="Buscar por IdLibro (opcional)" @bind="filtro" />
        </div>

        <!-- Menú -> /menu -->
        <NavLink href="/menu" style="text-decoration:none; color:black; display:block;">
            <div style="background:#0050FF; padding:8px 6px; display:flex; flex-direction:column; gap:3px; cursor:pointer;">
                <div style="height:2px; width:20px; background:black;"></div>
                <div style="height:2px; width:20px; background:black;"></div>
                <div style="height:2px; width:20px; background:black;"></div>
            </div>
        </NavLink>
    </div>

    <div style="flex:1; background:white; padding:16px 20px 0 20px; overflow:auto;">
        <div style="margin-bottom:10px;">Lista coincidencias</div>

        @if (error is not null)
        {
            <div style="padding:12px 0; color:red; white-space:pre-wrap;">@error</div>
        }
        else if (favoritos is null)
        {
            <div style="padding:12px 0;">Cargando...</div>
        }
        else if (!Filtrados.Any())
        {
            <div style="padding:12px 0;">No hay favoritos.</div>
        }
        else
        {
            @foreach (var f in Filtrados)
            {
                <div style="display:flex; justify-content:space-between; align-items:center;
                                    height:70px; border-bottom:2px solid #777FF5; margin-bottom:10px;">

                    <div style="display:flex; flex-direction:column;">
                        <div style="font-weight:bold;">Libro: @f.IdLibro</div>
                        <div style="font-size:12px;">
                            Marcado: @f.FechaAgregado.ToString("dd/MM/yyyy")
                        </div>
                    </div>

                    <button style="background:#FF4D4D; color:black; border:none; padding:10px 12px; cursor:pointer;"
                            @onclick="() => Quitar(f.IdLibro)">
                        Quitar
                    </button>
                </div>
            }
        }
    </div>
</div>

@code {
    private List<FavoritoDto>? favoritos;
    private string? error;
    private string filtro = "";

    private int usuarioId;                 // ✅ ahora existe
    private UsuarioPublicoDto? Usuario;    // opcional, por si querés mostrar nombre

    protected override async Task OnInitializedAsync()
    {
        Usuario = await Sesion.ObtenerUsuarioAsync();

        if (Usuario is null)
        {
            error = "No hay sesión iniciada.";
            favoritos = new(); // para que no quede null
            return;
        }

        usuarioId = Usuario.IdUsuario;     // ✅ sale de la sesión
        await Cargar();
    }

    private IEnumerable<FavoritoDto> Filtrados =>
        favoritos is null
            ? Enumerable.Empty<FavoritoDto>()
            : string.IsNullOrWhiteSpace(filtro)
                ? favoritos
                : favoritos.Where(f => f.IdLibro.ToString().Contains(filtro.Trim(), StringComparison.OrdinalIgnoreCase));

    private async Task Cargar()
    {
        try
        {
            error = null;
            favoritos = await FavoritoService.GetFavoritosByUsuarioAsync(usuarioId);
        }
        catch (Exception ex)
        {
            error = ex.ToString();
        }
    }

    private async Task Quitar(int idLibro)
    {
        try
        {
            error = null;
            await FavoritoService.RemoveFavoritoAsync(usuarioId, idLibro);
            await Cargar();
        }
        catch (Exception ex)
        {
            error = ex.ToString();
        }
    }
}
